

<style type="text/css">

	.chat{

	    position: fixed;

	    top: 0px;

	    left: 290px;

	    width: 240px;
    	z-index: 1;
	}

	.chat .count{

	    background: #FF1212;

	    padding: 3px 6px;

	    border-radius: 4px;

	    font-size: 11px;

	    float: right;

	    margin: -1px -7px 0px;

	}

	.chat .time{

		float: right;

    	font-size: 10px;

	}

	.chat-open{



	}

	.chat ul{

		margin: 0px;

	}

	.chat li span{

	    display: block;

	    font-weight: 600;

	    margin-bottom: 3px;

	}

	.chat .chat-header{

	    border-radius: 0px 0px 3px 3px;

	    background: #1A78A5;

	    padding: 10px 15px;

	    cursor: pointer;

		

	}

	.chat .messages{

		display: none;

		padding: 1px 15px;

		background: #fff;

		color: #333;

	}

	.chat .messages li{    

		list-style-type: none;

	    border-bottom: 1px solid #ccc;

	    padding: 0px 0px 10px;

	}

	.chat .messages li:last-child{  

	    border-bottom: 0px solid #ccc;

	    padding: 0px 0px 0px;

	}  

	.chat a{

		text-decoration: none;

	}

	.chat .btn{

	    background: #dfdfdf;

	    border: 1px solid #ccc;

	    margin-bottom: 10px;

	    text-align: center;

	    padding: 5px;

	    color: #333;

	    cursor: pointer;

	}





	.chat .shining {

	    -webkit-animation: mymoveno 1s infinite; /* Chrome, Safari, Opera */

	    animation: mymoveno 1s infinite;

	}



	/* Chrome, Safari, Opera */

	@-webkit-keyframes mymoveno {

	    0%   {background: #1A78A5;}

	    50%  {background: #34ADE6;}

	    100% {background: #1A78A5;}

	}



	@keyframes mymoveno {

	    0%   {background: #1A78A5;}

	    50%  {background: #34ADE6;}

	    100% {background: #1A78A5;}

	}



	.chat-lida{

	    position: fixed;

	    top: 0px;

	    left: 790px;

	    width: 240px;
    	z-index: 1;

	}

	.chat-lida .count{

	    background: #FF1212;

	    padding: 3px 6px;

	    border-radius: 4px;

	    font-size: 11px;

	    float: right;

	    margin: -1px -7px 0px;

	}

	.chat-lida .time{

		float: right;

    	font-size: 10px;

	}

	.chat-lida-open{



	}

	.chat-lida ul{

		margin: 0px;

	}

	.chat-lida li span{

	    display: block;

	    font-weight: 600;

	    margin-bottom: 3px;

	}

	.chat-lida .chat-header{

	    border-radius: 0px 0px 3px 3px;

	    background: #FFA03C;

	    padding: 10px 15px;

	    cursor: pointer;

		

	}

	.chat-lida .messages{

		display: none;

		padding: 1px 15px;

		background: #fff;

		color: #333;

	}

	.chat-lida .messages li{    

		list-style-type: none;

	    border-bottom: 1px solid #ccc;

	    padding: 0px 0px 10px;

	}

	.chat-lida .messages li:last-child{  

	    border-bottom: 0px solid #ccc;

	    padding: 0px 0px 0px;

	}  

	.chat-lida a{

		text-decoration: none;

	}

	.chat-lida .btn{

	    background: #dfdfdf;

	    border: 1px solid #ccc;

	    margin-bottom: 10px;

	    text-align: center;

	    padding: 5px;

	    color: #333;

	    cursor: pointer;

	}





	.chat-lida .shining {

	    -webkit-animation: mymove 1s infinite; /* Chrome, Safari, Opera */

	    animation: mymove 1s infinite;

	}



	/* Chrome, Safari, Opera */

	@-webkit-keyframes mymove {

	    0%   {background: #FFA03C;}

	    50%  {background: #E88925;}

	    100% {background: #FFA03C;}

	}



	@keyframes mymove {

	    0%   {background: #FFA03C;}

	    50%  {background: #E88925;}

	    100% {background: #FFA03C;}

	}











	.chat-new{

        position: fixed;

	    top: 0px;

	    left: 540px;

	    width: 240px;

    	z-index: 1;
	}

	.chat-new .chat-header{

	    border-radius: 0px 0px 3px 3px;

	    background: #2EA51A;

	    padding: 10px 15px;

	    cursor: pointer;

		

	}

	.chat-new ul{

		margin: 0px;

	}



	.chat-new .message{

		display: none;

		padding: 10px 15px;

		background: #fff;

		color: #333;

	}

	.chat-new label{

		line-height: 20px;

	}

	.chat-new .campo{

	    width: 210px;

	    border: 1px solid #dedede;

        padding: 4px 4px;

		margin-bottom: 10px;

	}

	.chat-new .campo:last-child{

	    width: 200px;

	}

	.chat-new .btn{

	    background: #dfdfdf;

	    border: 1px solid #ccc;

	    margin-bottom: 10px;

	    text-align: center;

	    padding: 5px;

	    color: #333;

	    width: 100%;

    	font-size: 12px;

	    cursor: pointer;

	}







	.financeiro-box{

        position: fixed;

	    top: 0px;

	    left: 1040px;

	    width: 240px;

	}

	.financeiro-box .chat-header{

	    border-radius: 0px 0px 3px 3px;

	    background: #a5541a;

	    padding: 10px 15px;

	    cursor: pointer;

		

	}

	.financeiro-box ul{

		margin: 0px;

	}



	.financeiro-box .message{

		display: none;

		padding: 10px 15px;

		background: #fff;

		color: #333;

	}

	.financeiro-box label{

		line-height: 20px;

	}

	.financeiro-box .campo{

	    width: 210px;

	    border: 1px solid #dedede;

        padding: 4px 4px;

		margin-bottom: 10px;

	}

	.financeiro-box .campo:last-child{

	    width: 200px;

	}

	.financeiro-box .btn{

	    background: #dfdfdf;

	    border: 1px solid #ccc;

	    margin-bottom: 10px;

	    text-align: center;

	    padding: 5px;

	    color: #333;

	    width: 100%;

    	font-size: 12px;

	    cursor: pointer;

	}

</style>



<div class="chat">



	<?php 

		if($_SESSION['sess_usuario_grupo_id']==4){



			$retUsuario	= Doctrine_Core::getTable('Usuario')->findByUsuarioGrupoId(4);



			foreach ($retUsuario as $objUsuario) {

				$recebida_por[] = "recebida_por = '".$objUsuario->id."'";

			}



			$where = "lida = 0 and (".implode(" or ", $recebida_por).")";



		}else if($_SESSION['sess_usuario_grupo_id']==1){

			$where = "lida = 0 and enviada_por <> '".$_SESSION['sess_usuario_id']."'";

		}else{

			$where = "lida = 0 and recebida_por = '".$_SESSION['sess_usuario_id']."'";



		}

		$retMensagem	= Doctrine_Query::create()->select()->from('Mensagem u')->where($where)->orderBy('data_mensagem asc')->execute();

		

	?>

	<div class="chat-header <?php echo $retMensagem->count()>0?"shining":""; ?>">

		<span class='count'><?php echo $retMensagem->count() ?></span> Mensagens

	</div>

	<div class="messages">

		<ul>

			<?php 

				foreach ($retMensagem as $objMensagem) {

					$objUsuario	= Doctrine_Core::getTable('Usuario')->find($objMensagem->enviada_por);

					$objUsuario2	= Doctrine_Core::getTable('Usuario')->find($objMensagem->recebida_por);



					?>

						<li codigo='<?php echo $objMensagem->id ?>'>

							<a href="<?php echo $_SESSION['sess_usuario_id']==$objMensagem->recebida_por||$_SESSION['sess_usuario_grupo_id']==1?URL_ADMIN.'mensagem/visualizar/'.$objMensagem->id:URL_ADMIN.'mensagem'; ?>/" style='color: #333'>

								<span style='float: right; width: 90px; text-align: right'><?php echo $objUsuario2->nome ?></span>

								<span style='float: right; width: 30px; font-weight: 400; text-align: center'>para</span>

								<span style='float: right; width: 90px;'><?php echo $objUsuario->nome ?></span> 

								<label class='time'><?php echo date('H:i:s', strtotime($objMensagem->data_mensagem)) ?></label>

								<?php echo $objMensagem->titulo ?>

							</a>

						</li>

					<?php

				}

			?>

		</ul>

		<a href="<?php echo URL_ADMIN ?>mensagem/"><div class='btn'>Ver Todas</div></a>

	</div>

</div>

<div class="chat-new">

	<div class="chat-header">

		Nova Mensagem

	</div>

	<div class="message">

		<label>Enviar para:</label>

		<select class="campo" id='usuario_id'>

			<option value="">Selecione</option>

			<?php

				$where = "id <> 1 and id <> '".$_SESSION['sess_usuario_id']."'";

				// $where = "id <> '".$_SESSION['sess_usuario_id']."'";

				$retUsuario	= Doctrine_Query::create()->select()->from('Usuario u')->where($where)->execute();



				foreach ($retUsuario as $objUsuario) {

					?><option value="<?php echo $objUsuario->id; ?>"><?php echo $objUsuario->nome; ?></option><?php

				}



			?>

		</select>



		<label>TÃ­tulo:</label>

		<select id="titulo" class="campo" style="width: 210px;">

			<!-- <option value=""></option> -->

			<?php

					

				$retAll		= 	Doctrine_Query::create()->select()->from('TipoMensagem')

								->where($where)->orderBy('nome ASC')->execute();



				foreach ($retAll as $key => $obj) {

					?><option><?php echo $obj->nome ?></option><?php

				}

			?>

		</select>

		<!-- <input class="campo" id='titulo' style='width: 200px;'> -->



		<label>Mensagem:</label>

		<textarea class="campo" id='mensagem' style='width: 200px;' rows=2></textarea>



		<button class='btn'>Enviar</button>

	</div>

	

</div>

<div class="chat-lida">



	<?php 

		if($_SESSION['sess_usuario_grupo_id']==4){



			$retUsuario	= Doctrine_Core::getTable('Usuario')->findByUsuarioGrupoId(4);



			foreach ($retUsuario as $objUsuario) {

				$enviada_por[] = "enviada_por = '".$objUsuario->id."'";

			}



			$where = "lida = 1 and confirmacao_lida = 0 and (".implode(" or ", $enviada_por).")";



		}else{

			$where = "lida = 1 and confirmacao_lida = 0 and enviada_por = '".$_SESSION['sess_usuario_id']."'";



		}

		$retMensagem	= Doctrine_Query::create()->select()->from('Mensagem u')->where($where)->orderBy('data_lida desc')->execute();

		

	?>

	<div class="chat-header <?php echo $retMensagem->count()>0?"shining":""; ?>">

		<span class='count'><?php echo $retMensagem->count() ?></span> Mensagens Lidas

	</div>

	<div class="messages">

		<ul>

			<?php 

				foreach ($retMensagem as $objMensagem) {

					$objUsuario	= Doctrine_Core::getTable('Usuario')->find($objMensagem->enviada_por);

					$objUsuario2	= Doctrine_Core::getTable('Usuario')->find($objMensagem->recebida_por);



					?>

						<li codigo='<?php echo $objMensagem->id ?>'>

							<!-- <a href="<?php echo $_SESSION['sess_usuario_id']==$objMensagem->enviada_por?URL_ADMIN.'mensagem/visualizar/'.$objMensagem->id:URL_ADMIN.'mensagem'; ?>/" style='color: #333'> -->

							<a href="javascript: void(0)" style='color: #333'>

								<span style='float: right; width: 90px; text-align: right'><?php echo $objUsuario2->nome ?></span>

								<span style='float: right; width: 30px; font-weight: 400; text-align: center'>para</span>

								<span style='float: right; width: 90px; '><?php echo $objUsuario->nome ?></span> 

								<label class='time'><?php echo date('H:i:s', strtotime($objMensagem->data_mensagem)) ?></label>

								<?php echo $objMensagem->titulo ?>

							</a>

						</li>

					<?php

				}

			?>

		</ul>

		<a href="<?php echo URL_ADMIN ?>mensagem/"><div class='btn'>Ver Todas</div></a>

	</div>

</div>

<?php if($_SESSION['sess_usuario_grupo_id']==1){ ?>

<div class="financeiro-box">

	<div class="chat-header">

		Financeiro

	</div>

	<div class="message">

		<label>Total a Receber:</label><br>

		<?php 

			$where = "tipo='credito' and data_baixa is null";

			// $where = "tipo='credito' and (data_baixa is null and data_vencimento >= '".date('Y-m-d')."') or data_baixa is null)";

			$retLancamento = Doctrine_Query::create()->select('sum(valor_total) as total')->from('Lancamento')->where($where)->execute();



			?><a href="<?php echo URL_ADMIN ?>relatorio-lancamento/detalhes/?tipo=credito&geral=1"><b>R$<?php echo number_format($retLancamento['0']['total'], 2, ',', '.'); ?></b></a><?php 

		?>

		<br><br>

		<label>Total a Pagar:</label><br>

		<?php 

			$where = "tipo='debito' and data_baixa is null";

			// $where = "tipo='debito' and data_baixa is null and data_vencimento >= '".date('Y-m-d')."'";

			$retLancamento = Doctrine_Query::create()->select('sum(valor_total) as total')->from('Lancamento')->where($where)->execute();



			?><a href="<?php echo URL_ADMIN ?>relatorio-lancamento/detalhes/?tipo=debito&geral=1"><b>R$<?php echo number_format($retLancamento['0']['total'], 2, ',', '.'); ?></b></a><?php 

		?>

	</div>

	

</div>

<?php } ?>

<script type="text/javascript">

	

	$('.financeiro-box .chat-header').click(function(){

		if($('.financeiro-box').hasClass('open')){

			$('.financeiro-box').removeClass('open');

			$('.financeiro-box .message').stop().slideUp();

		}else{

			$('.financeiro-box').addClass('open');

			$('.financeiro-box .message').stop().slideDown();

   			// $.ajax({

		 	// 		method: "POST",

			//   	dataType: "json",

			//   	url: URL_ADMIN+"lidaMensagem.php"

			// });

		}

	});

	$('.chat .chat-header').click(function(){

		if($('.chat').hasClass('open')){

			$('.chat').removeClass('open');

			$('.chat .messages').stop().slideUp();

		}else{

			$('.chat').addClass('open');

			$('.chat .messages').stop().slideDown();

   			// $.ajax({

		 	// 		method: "POST",

			//   	dataType: "json",

			//   	url: URL_ADMIN+"lidaMensagem.php"

			// });

		}

	});



	$('.chat-lida .chat-header').click(function(){

		if($('.chat-lida').hasClass('open')){

			$('.chat-lida').removeClass('open');

			$('.chat-lida .messages').stop().slideUp();

		}else{

			$('.chat-lida').addClass('open');

			$('.chat-lida .messages').stop().slideDown();

   			// $.ajax({

		 	// 		method: "POST",

			//   	dataType: "json",

			//   	url: URL_ADMIN+"lidaMensagem.php"

			// });

		}

	});



	$('.chat-new .chat-header').click(function(){

		if($('.chat-new').hasClass('open')){

			$('.chat-new').removeClass('open');

			$('.chat-new .message').stop().slideUp();

		}else{

			$('.chat-new').addClass('open');

			$('.chat-new .message').stop().slideDown();

			

		}

	});

	$('.chat-new .btn').click(function(){

		if($('.chat-new #usuario_id').val()!=''&&$('.chat-new #mensagem').val()!=''){

			$.ajax({

			  	method: "POST",

			  	dataType: "json",

			  	url: URL_ADMIN+"addMensagem.php",

			  	data: { usuario_id: $('.chat-new #usuario_id').val(), titulo: $('.chat-new #titulo').val(), mensagem: $('.chat-new #mensagem').val() }

			})

		  	.done(function( msg ) {

	   	 		alert( "Mensagem enviada!" );

	   	 		$('.chat-new #usuario_id').val('');

	   	 		$('.chat-new #mensagem').val('');

	   	 		$('.chat-new #titulo').val('');

	   	 		$('.chat-new .chat-header').trigger('click');

		  	});

		}

	});

	$('.chat-lida li').click(function(){

		var li = $(this);

		$.ajax({

		  	method: "POST",

		  	dataType: "json",

		  	url: URL_ADMIN+"updateMensagem.php",

		  	data: { mensagem_id: $(this).attr('codigo') }

		})

	  	.done(function( msg ) {

	   	 	alert( "Mensagem lida!" );

	   	 	$('.chat-lida .count').html(parseInt($('.chat .count').html())-1);

	   	 	li.fadeOut();

	  	});

	});

	setInterval(function(){ 

		$.getJSON( URL_ADMIN+"getMensagem.php", function( data ) {

		  	// console.log(data);

		  	$('.chat .messages ul').html(data.content);

		  	$('.chat .chat-header .count').html(data.count);



		  	if(data.count>0)

		  		$('.chat .chat-header').addClass('shining');

		  	else

		  		$('.chat .chat-header').removeClass('shining');

		});

	}, 3000);



	setInterval(function(){ 

		$.getJSON( URL_ADMIN+"getMensagemLida.php", function( data ) {

		  	// console.log(data);

		  	$('.chat-lida .messages ul').html(data.content);

		  	$('.chat-lida .chat-header .count').html(data.count);



		  	if(data.count>0)

		  		$('.chat-lida .chat-header').addClass('shining');

		  	else

		  		$('.chat-lida .chat-header').removeClass('shining');





			$('.chat-lida li').click(function(){

				var li = $(this);

				$.ajax({

				  	method: "POST",

				  	dataType: "json",

				  	url: URL_ADMIN+"updateMensagem.php",

				  	data: { mensagem_id: $(this).attr('codigo') }

				})

			  	.done(function( msg ) {

			   	 	alert( "Mensagem lida!" );

			   	 	$('.chat-lida .count').html(parseInt($('.chat-lida .count').html())-1);

			   	 	li.fadeOut();

			  	});

			});

		});





	}, 3000);



</script>